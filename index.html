<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Distribuidora Jazm√≠n - Premium</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
:root{
--primary:#00e676;
--dark:#111;
--bg:#1c1c1c;
--card:#1b1b1b;
--green:#28a745;
--red:#dc3545;
--white:#fff;
}
body{
margin:0;
font-family:'Poppins',sans-serif;
background:var(--bg);
color:var(--white);
}
header{
display:flex;
align-items:center;
justify-content:center;
gap:10px;
background:var(--dark);
padding:15px;
font-size:22px;
font-weight:bold;
position:relative;
cursor:pointer;
}
header img{
width:45px;
height:45px;
border-radius:50%;
}
#contador{
position:absolute;
right:20px;
top:15px;
background:var(--primary);
color:black;
font-weight:bold;
width:25px;
height:25px;
border-radius:50%;
display:flex;
align-items:center;
justify-content:center;
}
nav{
display:flex;
justify-content:center;
gap:12px;
padding:12px;
}
nav button{
padding:10px 18px;
border:none;
border-radius:25px;
background:#2c2c2c;
color:white;
cursor:pointer;
}
nav button.activo{
background:var(--primary);
color:black;
font-weight:bold;
}
input, select{
display:block;
margin:10px auto;
padding:10px;
width:90%;
max-width:400px;
border-radius:25px;
border:none;
background:#1f1f1f;
color:white;
}
.productos{
display:grid;
grid-template-columns:repeat(auto-fill,minmax(170px,1fr));
gap:15px;
padding:15px;
padding-bottom:300px;
}
.card{
background:var(--card);
padding:15px;
border-radius:20px;
text-align:center;
box-shadow:0 6px 20px rgba(0,0,0,0.5);
}
.precio{color:var(--primary);font-weight:bold;}
.sin{color:var(--red);}
.disp{color:var(--green);}
.controles{
display:flex;
justify-content:center;
align-items:center;
gap:10px;
margin-top:8px;
}
.controles button{
width:32px;
height:32px;
border:none;
border-radius:50%;
background:var(--primary);
color:black;
font-size:18px;
cursor:pointer;
}
#btnFlotante{
position:fixed;
bottom:20px;
right:20px;
width:60px;
height:60px;
border-radius:50%;
border:none;
background:var(--primary);
color:black;
font-size:26px;
box-shadow:0 8px 25px rgba(0,0,0,0.7);
cursor:pointer;
z-index:1100;
}
#carrito{
position:fixed;
bottom:0;
left:0;
right:0;
height:80vh;
background:var(--dark);
border-top-left-radius:30px;
border-top-right-radius:30px;
box-shadow:0 -30px 80px rgba(0,0,0,0.95);
transform:translateY(90%);
transition:0.4s;
display:flex;
flex-direction:column;
z-index:1000;
}
#carrito.abierto{transform:translateY(0);}
.barra-arrastre{
width:60px;
height:6px;
background:#555;
border-radius:10px;
margin:10px auto;
cursor:pointer;
}
.carrito-contenido{
flex:1;
overflow-y:auto;
padding:15px;
}
.item-carrito{
display:flex;
justify-content:space-between;
align-items:center;
margin-bottom:8px;
font-size:14px;
}
.carrito-footer{
background:#1a1a1a;
padding:12px;
border-top:1px solid #333;
}
.carrito-footer select,
.carrito-footer input{
width:100%;
margin-top:8px;
padding:8px;
border-radius:8px;
border:none;
}
.carrito-footer button{
margin-top:10px;
width:100%;
padding:10px;
border:none;
border-radius:20px;
background:var(--primary);
color:black;
font-weight:bold;
cursor:pointer;
}
.control-carrito{
display:flex;
align-items:center;
gap:6px;
}
.btn-cant{
width:28px;
height:28px;
border:none;
border-radius:50%;
background:var(--primary);
color:black;
font-weight:bold;
cursor:pointer;
}
.cant-num{
min-width:20px;
text-align:center;
font-weight:bold;
}
.btn-eliminar{
background:var(--red);
border:none;
border-radius:50%;
width:28px;
height:28px;
color:white;
font-weight:bold;
cursor:pointer;
}
/* Panel Admin */
.panel-admin{
position:fixed;
top:0;left:0;width:100%;height:100%;
background:#111;color:white;
display:none;
padding:40px;
z-index:2000;
overflow:auto;
}
.admin-box{
background:#222;padding:30px;border-radius:15px;max-width:600px;margin:auto;
}
.admin-box h2{margin-top:0;}
.close-admin{
background:var(--red);
margin-top:20px;
}
.producto{
  transition: all .25s ease;
}

.producto:hover{
  transform: scale(1.03);
  box-shadow: 0 8px 20px rgba(0,0,0,0.2);
}

@keyframes agregarAnim{
  0%{transform:scale(1);}
  50%{transform:scale(1.15);}
  100%{transform:scale(1);}
}

.animAgregar{
  animation: agregarAnim .3s ease;
}

/* Carrito deslizante */
.carrito{
  transition: right .3s ease;
}
.indicador-mayorista{
  margin-top:5px;
  padding:4px 8px;
  background:#28a74533;
  color:#28a745;
  font-weight:bold;
  border-radius:12px;
  font-size:12px;
  text-align:center;
}
.controles.mayorista button{
  border:2px solid #28a745;
}
</style>
</head>
<body>

<header onclick="accesoAdmin()">
<img src="https://i.postimg.cc/hPRrFtWD/Jazmin-png.jpg"> Distribuidora Jazm√≠n
<div id="contador">0</div>
</header>

<nav>
<button id="btnBebidas" class="activo">Bebidas</button>
<button id="btnAlmacen">Almac√©n</button>
</nav>

<input type="text" id="buscador" placeholder="Buscar producto...">
<div class="productos" id="productos"></div>

<!-- Bot√≥n flotante de WhatsApp -->
<button id="btnWhatsApp" onclick="enviarWhatsApp()" 
        style="
        position:fixed;
        bottom:100px;
        right:20px;
        width:60px;
        height:60px;
        border-radius:50%;
        border:none;
        background:#25D366;
        color:white;
        font-size:26px;
        box-shadow:0 8px 25px rgba(0,0,0,0.7);
        cursor:pointer;
        z-index:1100;
        ">
üì±
</button>

<!-- Bot√≥n flotante del carrito -->
<button id="btnFlotante" onclick="toggleCarrito()">üõí</button>

<div id="carrito">
<div class="barra-arrastre" onclick="toggleCarrito()"></div>
<div class="carrito-contenido" id="listaCarrito"></div>
<div class="carrito-footer">
<div id="total"></div>
<div id="detallePago" style="margin-top:8px;font-weight:bold;"></div>
<div id="envioInfo"></div>
<select id="tipoEntrega" onchange="actualizar()">
  <option value="domicilio">üè† Entrega a domicilio</option>
  <option value="coordinar_retiro">üè† Coordinar retiro en domicilio con vendedor</option>
</select>
<select id="zona" onchange="actualizar()">
<option value="">Seleccionar zona</option>
<option value="santafe">Santa Fe Capital</option>
<option value="centro">Zona Centro</option>
<option value="santotome">Santo Tom√©</option>
</select>
<input type="text" id="direccion" placeholder="Direcci√≥n">

<div id="senia"></div>

<!-- Tipo de pago -->
<select id="tipoPagoExtra" onchange="actualizar()">
  <option value="100">üíµ Pagar total</option>
  <option value="50">üßæ Se√±ar 50%</option>
</select>

<!-- Bot√≥n PDF -->
<button onclick="confirmarPedido()">Confirmar Pedido</button>

<!-- Bot√≥n WhatsApp -->
<button onclick="enviarWhatsApp()">
üì± Confirmar por WhatsApp
</button>

<hr style="margin:15px 0;border-color:#333;">

<button onclick="pagarMercadoPago()" style="background:#009ee3;color:white;">
üí≥ Pagar con Link Mercado Pago (6,42% recargo)
</button>

<button onclick="pagarAlias()" style="background:#00e676;color:black;">
üí∞ Pagar por Alias (sin recargo)
</button>

<button onclick="pagarTransferencia()" style="background:#2c2c2c;color:white;">
ü™ô Transferencia CBU (sin recargo)
</button>
</div>
</div>

<!-- Panel Admin -->
<div class="panel-admin" id="adminPanel">
<div class="admin-box">
<h2>Panel Privado - Admin</h2>
<p><strong>Total Productos:</strong> <span id="adminProductos"></span></p>
<p><strong>Total Items en Carrito:</strong> <span id="adminItems"></span></p>
<p><strong>Total Facturaci√≥n:</strong> $<span id="adminTotal"></span></p>
<button class="btn" onclick="vaciarCarrito()">Vaciar Carrito</button>
<button class="btn" onclick="exportarVentas()">Exportar PDF de Ventas</button>

<hr style="margin:20px 0; border-color:#555;">
<h3>Editar Productos</h3>
<select id="adminSelectProducto">
<option value="">Seleccionar producto</option>
</select>
<input type="number" id="adminPrecio" placeholder="Nuevo precio">
<select id="adminEstado">
<option value="DISPONIBLE">DISPONIBLE</option>
<option value="SIN STOCK">SIN STOCK</option>
</select>
<button onclick="guardarCambios()">Guardar Cambios</button>
<div id="adminMsg" style="margin-top:10px; color:var(--primary)"></div>

<button class="btn close-admin" onclick="cerrarAdmin()">Cerrar Panel</button>
</div>
</div>


<script>
function calcularTotalActual(){
let total=0;
Object.values(carrito).forEach(p=>{
let precioUnit=calcularPrecioFinal(p,p.cantidad);
total+=precioUnit*p.cantidad;
});
return total;
}

function pagarMercadoPago(){

  if(Object.keys(carrito).length===0){
    alert("Carrito vac√≠o");
    return;
  }

// 1 Total productos
let totalProductos = calcularTotalActual();

// 2 Calcular env√≠o
const envio = calcularEnvio(totalProductos);
let subtotal = totalProductos;
if(envio.ok){
  subtotal += envio.costo;
}

// 3 Aplicar tipo de pago
const tipoPago = document.getElementById("tipoPagoExtra")?.value || "100";
let totalConPago = subtotal;
if(tipoPago === "50"){
  totalConPago = subtotal * 0.5;
}

// 4 Aplicar recargo Mercado Pago
let recargo = totalConPago * 0.0642;
let totalFinal = totalConPago + recargo;

alert(
  "Pago con Mercado Pago\n\n" +
  "Total productos: $" + totalProductos.toLocaleString() +
  "\nEnv√≠o: $" + (envio.ok ? envio.costo.toLocaleString() : "0") +
  "\nSubtotal: $" + subtotal.toLocaleString() +
  (tipoPago==="50" ? "\nSe√±a 50%: $" + totalConPago.toLocaleString() : "") +
  "\nRecargo 6,42%: $" + recargo.toLocaleString() +
  "\n\nTOTAL FINAL: $" + totalFinal.toLocaleString()
);

  window.open(LINK_MP, "_blank");
}

function pagarAlias(){

  if(Object.keys(carrito).length===0){
    alert("Carrito vac√≠o");
    return;
  }

  let totalProductos = calcularTotalActual();
  const envio = calcularEnvio(totalProductos);

  let totalConEnvio = totalProductos;

  if(envio.ok){
    totalConEnvio += envio.costo;
  }

  alert(
    "Alias: " + ALIAS +
    "\n\nTotal productos: $" + totalProductos.toLocaleString() +
    "\nEnv√≠o: $" + (envio.ok ? envio.costo.toLocaleString() : "0") +
    "\n\nTOTAL A TRANSFERIR: $" + totalConEnvio.toLocaleString() +
    "\n\n(Sin recargo)"
  );

}

function pagarTransferencia(){

  if(Object.keys(carrito).length===0){
    alert("Carrito vac√≠o");
    return;
  }

  let totalProductos = calcularTotalActual();
  const envio = calcularEnvio(totalProductos);

  let totalConEnvio = totalProductos;

  if(envio.ok){
    totalConEnvio += envio.costo;
  }

  alert(
    "CBU: " + CBU +
    "\n\nTotal productos: $" + totalProductos.toLocaleString() +
    "\nEnv√≠o: $" + (envio.ok ? envio.costo.toLocaleString() : "0") +
    "\n\nTOTAL A TRANSFERIR: $" + totalConEnvio.toLocaleString() +
    "\n\n(Sin recargo)"
  );

}
const { jsPDF } = window.jspdf;

const PASSWORD="Jazmin2026Admin";
const SHEET_URL="1ulQgsiH4VPgtws9Abo8wGo4xcwWHVi-hEkeKUqUbRWE";

let productosBebidas=[];
let productosAlmacen=[];
let productos=[];
let todos=[];
let carrito={};

const MINIMO_GENERAL=60000;
const MINIMO_SANTO_TOME=80000;

async function cargarDatos(){
  try{

    const urlBebidas=`https://opensheet.elk.sh/${SHEET_URL}/bebidas`;
    const urlAlmacen=`https://opensheet.elk.sh/${SHEET_URL}/almacen`;

    const [rB,rA]=await Promise.all([
      fetch(urlBebidas),
      fetch(urlAlmacen)
    ]);

    productosBebidas = await rB.json();
    productosAlmacen = await rA.json();

    //  LIMPIAR ESPACIOS EN CODIGOS (MUY IMPORTANTE)
    productosBebidas.forEach(p=>{
      if(p.codigo){
        p.codigo = p.codigo.trim();
      }
    });

    productosAlmacen.forEach(p=>{
      if(p.codigo){
        p.codigo = p.codigo.trim();
      }
    });

    // Si despu√©s un√≠s todo en un array general:
    todos = [...productosBebidas, ...productosAlmacen];

    mostrar(); // o la funci√≥n que uses para pintar productos

  }catch(error){
    console.error("Error cargando datos:", error);
  }
}

function mostrar(){
  const cont = document.getElementById("productos");
  cont.innerHTML = "";

  const filtro = document.getElementById("buscador").value.toLowerCase();
  let base = productos.length ? productos : todos;

  let lista = filtro
    ? todos.filter(p => p.producto?.toLowerCase().includes(filtro))
    : base;

  lista.forEach(p => {
    if(!p.codigo || !p.producto) return;

    let precioNum = Number(p.precio);
    if(isNaN(precioNum)) return;

    // Cantidad en carrito
    const cantidadEnCarrito = carrito[p.codigo]?.cantidad || 0;

    // Verificar si aplica descuento mayorista
    const aplicaMayorista = cantidadEnCarrito >= 6;
    const mayorista = aplicaMayorista
      ? `<div class="indicador-mayorista">üí∞ Descuento mayorista 5%</div>`
      : "";

    // Agregar clase especial a los botones si aplica mayorista
    const controlesClass = aplicaMayorista ? "controles mayorista" : "controles";

    const div = document.createElement("div");
    div.className = "card";
    div.setAttribute("data-codigo", p.codigo);
    div.innerHTML = `
      <h4>${p.producto}</h4>
      <div class="precio">$${precioNum.toLocaleString()}</div>
      ${mayorista}
      <div class="${p.estado === "SIN STOCK" ? "sin" : "disp"}">${p.estado || "DISPONIBLE"}</div>
      <div class="${controlesClass}">
        <button onclick="cambiarCantidad('${p.codigo}',-1)">-</button>
        <span id="cantidad-${p.codigo}">${cantidadEnCarrito}</span>
        <button onclick="cambiarCantidad('${p.codigo}',1)">+</button>
      </div>
    `;
    cont.appendChild(div);
  });
}

function agregar(codigo){
  const producto = todos.find(p => p.codigo === codigo);
  if(!producto || producto.estado === "SIN STOCK") return;

  if(!carrito[codigo]){
    carrito[codigo] = {...producto, cantidad:1};
  } else {
    carrito[codigo].cantidad++;
  }

  actualizar();
  mostrar();
  animarCarritoIcono();

  const card = document.querySelector(`[data-codigo="${codigo}"]`);
  if(card){
    card.classList.add("animAgregar");
    setTimeout(()=>card.classList.remove("animAgregar"),300);
  }

  const audio = new Audio("https://assets.mixkit.co/sfx/preview/mixkit-select-click-1109.mp3");
  audio.volume = 0.2;
  audio.play();
}

function actualizar(){
  let total=0;
  let cant=0;

  const lista=document.getElementById("listaCarrito");
  lista.innerHTML="";

  Object.values(carrito).forEach(p=>{
    const precioUnit = calcularPrecioFinal(p,p.cantidad);
const sub = precioUnit * p.cantidad;
    total+=sub;
    cant+=p.cantidad;

    lista.innerHTML+=`
    <div class="item-carrito">
      <span style="flex:1;">${p.producto}</span>
      <div class="control-carrito">
        <button class="btn-cant" onclick="cambiarCantidad('${p.codigo}',-1)">‚ûñ</button>
        <span class="cant-num">${p.cantidad}</span>
        <button class="btn-cant" onclick="cambiarCantidad('${p.codigo}',1)">‚ûï</button>
        <button class="btn-eliminar" onclick="eliminarProducto('${p.codigo}')">‚ùå</button>
      </div>
    </div>`;
  });

  document.getElementById("contador").innerText=cant;

  let totalFinal = total;

document.getElementById("detallePago").innerHTML =
  "<span style='color:green;'>Alias y CBU sin recargo. Mercado Pago link tiene 6,42% extra.</span>";

const pagoElement = document.getElementById("tipoPagoExtra");
const tipoPago = pagoElement ? pagoElement.value : "100";

const envio = calcularEnvio(total);

document.getElementById("envioInfo").innerHTML = envio.mensaje;

let totalConEnvio = total;

if(envio.ok){
  totalConEnvio += envio.costo;

}

if(tipoPago === "50"){

  const senia = totalConEnvio * 0.5;
  const saldo = totalConEnvio - senia;

  document.getElementById("total").innerHTML = `
    <strong>Total del pedido:</strong> $${totalConEnvio.toLocaleString()}<br>
    <strong>Se√±a a pagar ahora:</strong> $${senia.toLocaleString()}<br>
    <strong>Saldo pendiente:</strong> $${saldo.toLocaleString()}
  `;

}else{

  document.getElementById("total").innerHTML =
    "<strong>Total a pagar:</strong> $" + totalConEnvio.toLocaleString();
}
  
}
function eliminarProducto(codigo){
  delete carrito[codigo];
  actualizar();
  mostrar();
}

function confirmarPedido(){

  if(Object.keys(carrito).length===0){
    alert("Carrito vac√≠o");
    return;
  }

  const totalProductos = calcularTotalActual();
  const envio = calcularEnvio(totalProductos);

  let totalConEnvio = totalProductos;
  if(envio.ok){
    totalConEnvio += envio.costo;
  }

  const tipoPago = document.getElementById("tipoPagoExtra")?.value || "100";
  let totalFinal = tipoPago === "50"
    ? totalConEnvio * 0.5
    : totalConEnvio;

  generarPDFProfesional(totalFinal);
}

document.getElementById("buscador").addEventListener("input",mostrar);

const btnBebidas = document.getElementById("btnBebidas");
const btnAlmacen = document.getElementById("btnAlmacen");

btnBebidas.onclick=()=>{
  productos=productosBebidas;
  btnBebidas.classList.add("activo");
  btnAlmacen.classList.remove("activo");
  mostrar();
};

btnAlmacen.onclick=()=>{
  productos=productosAlmacen;
  btnAlmacen.classList.add("activo");
  btnBebidas.classList.remove("activo");
  mostrar();
};

async function init(){
  await cargarDatos();
  actualizar();
}

init();
/* =========================
   ‚öôÔ∏è CONFIGURACIONES EXTRA
========================= */

const WHATSAPP_NUMERO="543425695340";
const LINK_MP="https://link.mercadopago.com.ar/distribuidorajazmin";
const MP_RECARGO=1.0642; // 6,42%
const ALIAS="jazminonlineshop";
const CBU="0000003100054608688074";
const FRASE_CONFIANZA="Gracias por confiar en Distribuidora Jazm√≠n. Calidad, compromiso y confianza en cada entrega.";

/* =========================
   üí∞ PRECIO MAYORISTA (6+ unidades)
========================= */

function calcularPrecioFinal(producto,cantidad){
  let precio = Number(producto.precio);
  if(cantidad>=6){
    precio = precio * 0.95; // 5% descuento mayorista
  }
  return precio;
}

/* =========================
   üöö  ENV√çO INTELIGENTE
========================= */

function calcularEnvio(total){
  const zonaElement = document.getElementById("zona");
const tipoEntregaElement = document.getElementById("tipoEntrega");

const zona = zonaElement ? zonaElement.value : "";
const tipoEntrega = tipoEntregaElement ? tipoEntregaElement.value : "";
  if(tipoEntrega === "coordinar_retiro"){
  return {
    ok: true,
    mensaje: "Entrega coordinada de retiro en domicilio con vendedor (sin costo de env√≠o)",
    costo: 0
  };
}

  let costoEnvio = 0;
  let mensaje = "";

  if(zona === "santafe"){
    if(total >= 100000){
      mensaje = "üöö Env√≠o GRATIS en Santa Fe por superar $100.000";
      costoEnvio = 0;
    }else{
      costoEnvio = 2000;
      mensaje = "Costo de env√≠o Santa Fe: $" + costoEnvio.toLocaleString();
    }

  } else if(zona === "centro"){
    costoEnvio = 2500;
    mensaje = "Costo de env√≠o Zona Centro: $" + costoEnvio.toLocaleString();

  } else if(zona === "santotome"){
    if(total >= 120000){
      mensaje = "üöö Env√≠o GRATIS en Santo Tom√© por superar $120.000";
      costoEnvio = 0;
    }else{
      costoEnvio = 6000;
      mensaje = "Costo de env√≠o Santo Tom√©: $" + costoEnvio.toLocaleString();
    }

  } else {
    mensaje = "Seleccione una zona para calcular env√≠o";
    return { ok:false, mensaje, costo:0 };
  }

  return { ok:true, mensaje, costo:costoEnvio };
}

/* =========================
   üíµ OPCI√ìN PAGO 50% o 100%
========================= */

function calcularPago(total){
  const tipoPago = document.getElementById("tipoPagoExtra")?.value || "100";
  if(tipoPago==="50"){
    return total*0.5;
  }
  return total;
}

/* =========================
   üìÑ PDF PROFESIONAL MEJORADO
========================= */

function generarPDFProfesional(totalFinal){
  const fecha = new Date().toLocaleString("es-AR");
  const direccion = document.getElementById("direccion")?.value || "No especificada";
  const esSenia = document.getElementById("tipoPagoExtra")?.value === "50";
  const formaPago = esSenia ? "Se√±a 50%" : "Pago total";

  const doc = new jsPDF("p","mm","a4");
  const width = doc.internal.pageSize.getWidth();
  const height = doc.internal.pageSize.getHeight();

  // Fondo claro sin usar alfa
  doc.setFillColor(255, 182, 193); // rosa pastel
  doc.rect(0,0,width,height,"F"); // relleno total

  // Bordes dorados
  doc.setDrawColor(212,175,55);
  doc.setLineWidth(2);
  doc.rect(5,5,width-10,height-10);

  // Logo arriba
  const logoURL = "https://i.postimg.cc/hPRrFtWD/Jazmin-png.jpg";
  const img = new Image();
  img.src = logoURL;
  img.onload = function(){
    doc.addImage(img, "PNG", 10, 10, 35, 35);

    // Marca de agua (opacidad simulada)
    doc.setTextColor(0,0,0,15); // jsPDF alfa no siempre funciona, usamos gris clarito
    doc.setFontSize(60);
    doc.text("Distribuidora Jazm√≠n", width/2, height/2, {align:"center", angle:45});
    doc.setTextColor(0,0,0); // reset color
    doc.setFontSize(12);

    // Encabezado
    doc.text("Distribuidora Jazm√≠n", width/2, 25, {align:"center"});
    doc.text("Calidad, compromiso y confianza en cada entrega.", width/2, 32, {align:"center"});
    doc.text(`Fecha: ${fecha}`, 20, 45);
    doc.text(`Direcci√≥n: ${direccion}`, 20, 53);
    doc.text(`Forma de pago: ${formaPago}`, 20, 61);

    // Detalle productos
    let y = 75;
    Object.values(carrito).forEach(p=>{
      const precioUnit = calcularPrecioFinal(p,p.cantidad);
      const sub = precioUnit * p.cantidad;
      const mayorista = p.cantidad >=6 ? " (Mayorista 5%)" : "";
      doc.text(`${p.producto}${mayorista} x${p.cantidad} - $${sub.toLocaleString()}`, 20, y);
      y+=8;
    });

    // Total
    doc.setFontSize(14);
    doc.text(`Total a pagar: $${totalFinal.toLocaleString()}`, 20, y+10);

    if(esSenia){
      const saldo = totalFinal * 2 - totalFinal;
      doc.setFontSize(11);
      doc.text(`Saldo pendiente: $${saldo.toLocaleString()}`, 20, y+18);
    }

    // Footer
    doc.setFontSize(9);
    doc.text(`Distribuidora Jazm√≠n - ${fecha}`, width/2, height-10, {align:"center"});

    doc.save("Pedido_Distribuidora_Jazmin.pdf");
  };
}

/* =========================
   üì± WHATSAPP CONFIRMACI√ìN
========================= */

function enviarWhatsApp(){
  if(Object.keys(carrito).length===0){
    alert("Carrito vac√≠o");
    return;
  }

  const zona = document.getElementById("zona")?.value;
  const direccion = document.getElementById("direccion")?.value;

  if(!zona){
    alert("Seleccion√° una zona");
    return;
  }

  if(!direccion){
    alert("Ingres√° una direcci√≥n");
    return;
  }

  const totalProductos = calcularTotalActual();
  const envio = calcularEnvio(totalProductos);
  let totalConEnvio = totalProductos;
  if(envio.ok) totalConEnvio += envio.costo;

  const tipoPago = document.getElementById("tipoPagoExtra")?.value || "100";
  const esSenia = tipoPago === "50";
  const totalFinal = esSenia ? totalConEnvio * 0.5 : totalConEnvio;

  let mensaje = "Hola Distribuidora Jazm√≠n üëã\n\nQuiero confirmar el siguiente pedido:\n\n";
  Object.values(carrito).forEach(p => {
    mensaje += `- ${p.producto} x${p.cantidad}\n`;
  });
  mensaje += `\nZona: ${zona}\nDirecci√≥n: ${direccion}`;
  mensaje += `\n\nTotal pedido: $${totalConEnvio.toLocaleString()}`;
  if(esSenia){
    mensaje += `\nSe√±a 50%: $${totalFinal.toLocaleString()}`;
    mensaje += `\nSaldo pendiente: $${(totalConEnvio - totalFinal).toLocaleString()}`;
  }
  mensaje += "\n\nGracias üôå";

  window.open(`https://wa.me/${WHATSAPP_NUMERO}?text=${encodeURIComponent(mensaje)}`, "_blank");
}


/* =========================
   üí≥ MERCADO PAGO CON RECARGO
========================= */

function pagarConMP(total){
  const totalMP = total * MP_RECARGO;
  window.open(LINK_MP,"_blank");
  alert("El precio con Mercado Pago incluye 6,42% de recargo.\nTotal con recargo: $"+totalMP.toLocaleString());
}


/* =========================
   üí≥ AGREGAR SELECT PAGO DIN√ÅMICO
========================= */


function animarCarritoIcono(){
  const icono=document.getElementById("btnFlotante");
  if(!icono) return;

  icono.style.transition="transform .2s ease";
  icono.style.transform="scale(1.2)";
  setTimeout(()=>{
    icono.style.transform="scale(1)";
  },200);
}
function cambiarCantidad(codigo, cambio){
  const producto = todos.find(p => p.codigo === codigo);
  if(!producto) return;

  // Bloquear si el producto est√° SIN STOCK
  if(producto.estado === "SIN STOCK" && cambio > 0){
    alert(`El producto "${producto.producto}" est√° SIN STOCK`);
    return;
  }

  if(!carrito[codigo]){
    if(cambio > 0){
      carrito[codigo] = {...producto, cantidad:1};
    }
  } else {
    carrito[codigo].cantidad += cambio;

    if(carrito[codigo].cantidad <= 0){
      delete carrito[codigo];
    }
  }

  actualizar();
  mostrar();
}

/* =========================
   üîê PANEL ADMIN FUNCIONAL
========================= */

function accesoAdmin(){
  const pass = prompt("Ingrese contrase√±a de administrador:");
  if(pass === PASSWORD){
    document.getElementById("adminPanel").style.display="block";
    actualizarAdmin();
    cargarSelectAdmin();
  } else {
    alert("Contrase√±a incorrecta");
  }
}

function cerrarAdmin(){
  document.getElementById("adminPanel").style.display="none";
}

function actualizarAdmin(){
  document.getElementById("adminProductos").innerText = todos.length;

  let totalItems = 0;
  let totalFacturacion = 0;

  Object.values(carrito).forEach(p=>{
    totalItems += p.cantidad;
    totalFacturacion += Number(p.precio) * p.cantidad;
  });

  document.getElementById("adminItems").innerText = totalItems;
  document.getElementById("adminTotal").innerText = totalFacturacion.toLocaleString();
}

function vaciarCarrito(){
  carrito = {};
  actualizar();
  alert("Carrito vaciado");
  actualizarAdmin();
}

function cargarSelectAdmin(){
  const select = document.getElementById("adminSelectProducto");
  select.innerHTML = '<option value="">Seleccionar producto</option>';

  todos.forEach(p=>{
    if(p.codigo){
      select.innerHTML += `<option value="${p.codigo}">${p.producto}</option>`;
    }
  });
}

function guardarCambios(){
  const codigo = document.getElementById("adminSelectProducto").value;
  const nuevoPrecio = document.getElementById("adminPrecio").value;
  const nuevoEstado = document.getElementById("adminEstado").value;

  const producto = todos.find(p=>p.codigo === codigo);

  if(!producto){
    alert("Seleccione un producto");
    return;
  }

  if(nuevoPrecio){
    producto.precio = nuevoPrecio;
  }

  producto.estado = nuevoEstado;

  document.getElementById("adminMsg").innerText = "Cambios guardados (solo sesi√≥n actual)";
  mostrar();
}

function exportarVentas(){
  const doc = new jsPDF();
  doc.setFontSize(16);
  doc.text("Reporte de Ventas - Distribuidora Jazm√≠n",20,20);

  let y = 40;
  Object.values(carrito).forEach(p=>{
    doc.text(`${p.producto} x${p.cantidad}`,20,y);
    y+=10;
  });

  doc.save("Reporte_Ventas.pdf");
}
function toggleCarrito() {
  const carritoDiv = document.getElementById("carrito");
  if (!carritoDiv) return;
  carritoDiv.classList.toggle("abierto");
}
</script>
