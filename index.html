<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Distribuidora Jazmín</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
*{box-sizing:border-box;margin:0;padding:0;}
body{font-family:Arial, sans-serif;background:#f4f4f4;}

header{
background:#111;
color:white;
padding:15px;
text-align:center;
font-size:22px;
font-weight:bold;
}

.buscador{
padding:15px;
background:white;
display:flex;
gap:10px;
position:sticky;
top:0;
z-index:10;
}

.buscador input{
flex:1;
padding:10px;
border:1px solid #ccc;
border-radius:6px;
}

button{
padding:10px 15px;
border:none;
border-radius:6px;
cursor:pointer;
font-weight:bold;
}

.btn-carrito{
background:#25D366;
color:white;
}

.categorias{
display:flex;
gap:10px;
padding:10px;
background:white;
}

.categorias button{
flex:1;
background:#333;
color:white;
}

.productos{
display:grid;
grid-template-columns:repeat(auto-fill,minmax(170px,1fr));
gap:12px;
padding:15px;
}

.card{
background:white;
padding:10px;
border-radius:8px;
box-shadow:0 2px 5px rgba(0,0,0,0.1);
display:flex;
flex-direction:column;
gap:6px;
}

.card h4{
font-size:14px;
}

.precio{
font-weight:bold;
color:#000;
}

.mayorista{
color:#d10000;
font-size:13px;
}

.stock{
font-size:12px;
color:gray;
}

.card button{
background:#111;
color:white;
}

#carrito{
position:fixed;
right:-400px;
top:0;
width:350px;
height:100%;
background:white;
box-shadow:-3px 0 10px rgba(0,0,0,0.2);
padding:15px;
transition:0.3s;
overflow:auto;
z-index:20;
}

#carrito.abierto{
right:0;
}

.item-carrito{
display:flex;
justify-content:space-between;
margin-bottom:10px;
font-size:14px;
}

.total{
font-weight:bold;
margin-top:10px;
}

.formulario{
margin-top:15px;
display:flex;
flex-direction:column;
gap:8px;
}

.formulario input{
padding:8px;
border:1px solid #ccc;
border-radius:5px;
}

.btn-cerrar{
background:#999;
color:white;
margin-bottom:10px;
}

.btn-confirmar{
background:#25D366;
color:white;
}

.reserva{
font-size:13px;
color:#d10000;
margin-top:5px;
}
</style>
</head>

<body>

<header>Distribuidora Jazmín</header>

<div class="buscador">
<input type="text" id="buscar" placeholder="Buscar producto...">
<button class="btn-carrito" onclick="toggleCarrito()">Carrito</button>
</div>

<div class="categorias">
<button onclick="cargarCategoria('bebidas')">Bebidas</button>
<button onclick="cargarCategoria('almacen')">Almacén</button>
</div>

<div class="productos" id="productos"></div>

<div id="carrito">
<button class="btn-cerrar" onclick="toggleCarrito()">Cerrar</button>

<h3>Tu pedido</h3>
<div id="listaCarrito"></div>
<div class="total" id="total"></div>
<div class="reserva">Se solicita 50% de reserva para confirmar pedido</div>

<div class="formulario">
<input type="text" id="nombre" placeholder="Nombre" required>
<input type="text" id="direccion" placeholder="Dirección (obligatoria)" required>
<button class="btn-confirmar" onclick="confirmarPedido()">Confirmar por WhatsApp</button>
<button onclick="generarPDF()">Descargar PDF</button>
</div>
</div>

<script>
const sheetID = "1UvkRq1iKUc0wu7qJ7AKufIre6owQfsnBmKZAAtuJQpk";
const bebidasURL = `https://opensheet.elk.sh/${sheetID}/Bebidas`;
const almacenURL = `https://opensheet.elk.sh/${sheetID}/Almacén`;

let productos = [];
let carrito = [];

async function cargarCategoria(cat){
let url = cat === "bebidas" ? bebidasURL : almacenURL;
let res = await fetch(url);
let data = await res.json();
productos = data;
mostrarProductos(productos);
}

function mostrarProductos(lista){
const cont = document.getElementById("productos");
cont.innerHTML = "";

lista.forEach(prod=>{
if(prod.Estado && prod.Estado.toLowerCase() === "inactivo") return;

let precio = parseFloat(prod.Precio);
let mayorista = (prod.Producto.includes("6UNI") || prod.Producto.includes("x6")) 
? precio * 6 * 0.9 
: precio * 10 * 0.9;

let card = document.createElement("div");
card.className = "card";

card.innerHTML = `
<h4>${prod.Producto}</h4>
<div class="precio">$${precio.toLocaleString()}</div>
<div class="mayorista">Mayorista: $${Math.round(mayorista).toLocaleString()}</div>
<div class="stock">Stock: ${prod.Stock}</div>
<button onclick='agregarAlCarrito(${JSON.stringify(prod)})'>Agregar</button>
`;

cont.appendChild(card);
});
}

document.getElementById("buscar").addEventListener("input", e=>{
let texto = e.target.value.toLowerCase();
let filtrados = productos.filter(p=> 
p.Producto.toLowerCase().includes(texto)
);
mostrarProductos(filtrados);
});

function agregarAlCarrito(prod){
let existe = carrito.find(p=>p.Producto===prod.Producto);
if(existe){
existe.cantidad++;
}else{
carrito.push({...prod, cantidad:1});
}
actualizarCarrito();
}

function actualizarCarrito(){
const lista = document.getElementById("listaCarrito");
lista.innerHTML="";
let total = 0;

carrito.forEach(p=>{
let precio = parseFloat(p.Precio);
let subtotal = precio * p.cantidad;
total += subtotal;

lista.innerHTML += `
<div class="item-carrito">
${p.Producto} x${p.cantidad}
<span>$${subtotal.toLocaleString()}</span>
</div>
`;
});

document.getElementById("total").innerText = "Total: $" + total.toLocaleString();
}

function toggleCarrito(){
document.getElementById("carrito").classList.toggle("abierto");
}

function confirmarPedido(){
let nombre = document.getElementById("nombre").value;
let direccion = document.getElementById("direccion").value;

if(!nombre || !direccion){
alert("Completar nombre y dirección");
return;
}

let mensaje = `Pedido Distribuidora Jazmín%0A%0A`;
carrito.forEach(p=>{
mensaje += `${p.Producto} x${p.cantidad}%0A`;
});
mensaje += `%0ATotal: ${document.getElementById("total").innerText}%0A`;
mensaje += `Reserva 50%% requerida%0A`;
mensaje += `Nombre: ${nombre}%0A`;
mensaje += `Dirección: ${direccion}`;

window.open(`https://wa.me/5493425695340?text=${mensaje}`);
}

function generarPDF(){
const { jsPDF } = window.jspdf;
let doc = new jsPDF();

doc.text("Distribuidora Jazmín", 10, 10);
let y = 20;

carrito.forEach(p=>{
doc.text(`${p.Producto} x${p.cantidad}`, 10, y);
y += 8;
});

doc.text(document.getElementById("total").innerText, 10, y+5);
doc.save("pedido.pdf");
}

</script>
</body>
  </html>
